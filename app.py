from flask import Flask, render_template, request, jsonify
from flask_cors import CORS
from dotenv import load_dotenv
import os
import google.generativeai as genai
import re
import traceback

load_dotenv()

app = Flask(__name__, static_folder='static', template_folder='templates')
CORS(app)

# ‚úÖ Gemini setup with recommended stable model
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
model = genai.GenerativeModel("gemini-1.5-pro-latest")

# ‚úÖ Utility to cap scores at 10
def cap_scores(text):
    return re.sub(r'(\d{2,})/10', lambda m: f"{min(int(m.group(1)), 10)}/10", text)

@app.route("/")
def home():
    return render_template("index.html")

@app.route("/review", methods=["POST"])
def review():
    try:
        data = request.get_json()
        prd_text = data.get("prd_text", "").strip()

        if not prd_text:
            return jsonify({"response": "‚ùå No PRD text provided."}), 400

        prompt = f"""
        You are a senior product reviewer AI. Analyze the PRD below and respond **only** in the following JSON format:

        {{
          "summary": "one-paragraph summary here",
          "scores": {{
            "clarity": number between 0 and 10,
            "structure": number between 0 and 10,
            "completeness": number between 0 and 10,
            "ambiguity": number between 0 and 10,
            "stakeholder_consideration": number between 0 and 10,
            "technical_depth": number between 0 and 10,
            "feasibility": number between 0 and 10,
            "business_impact_alignment": number between 0 and 10
          }},
          "strengths": ["point 1", "point 2"],
          "areas_for_improvement": ["point 1", "point 2"]
        }}

        Rules:
        - Respond with valid JSON only.
        - All fields are mandatory.
        - Each score must be between 0 and 10.
        - Do not write anything outside the JSON.

        PRD:
        \"\"\"
        {prd_text}
        \"\"\"
        """

        response = model.generate_content(prompt)

        if response.text:
            print("‚úÖ Gemini Raw Response:\n", response.text)
            safe_text = cap_scores(response.text)
            return jsonify({"response": safe_text})
        else:
            print("‚ö†Ô∏è Gemini returned empty response")
            return jsonify({"response": "‚ùå No response generated by Gemini."}), 500

    except Exception as e:
        print("üî• Error:", e)
        traceback.print_exc()
        return jsonify({"response": f"‚ùå Server error: {str(e)}"}), 500
